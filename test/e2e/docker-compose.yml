version: '3'
services:
  mongo:
    image: mongo:3.6
    restart: always
    networks:
      - crawlerd-e2e-test

  etcd:
    image: bitnami/etcd:3
    environment:
      #TODO: auth
      ALLOW_NONE_AUTHENTICATION: "yes"
    restart: always
    networks:
      - crawlerd-e2e-test

  api:
    build:
      context: ../../
      dockerfile: Dockerfile
    depends_on:
      - mongo
    entrypoint: ./api -mongo-host mongo -scheduler-addr scheduler:9888
    networks:
      - crawlerd-e2e-test

  scheduler:
    build:
      context: ../../
      dockerfile: Dockerfile
    depends_on:
      - mongo
      - etcd
    entrypoint: ./scheduler -etcd-host etcd -mongo-host mongo
    networks:
      - crawlerd-e2e-test

  worker:
    build:
      context: ../../
      dockerfile: Dockerfile
    depends_on:
      - mongo
      - etcd
    entrypoint: ./worker -etcd-host etcd -mongo-host mongo
    networks:
      - crawlerd-e2e-test

  tests:
    build:
      context: ../../
      dockerfile: Dockerfile.test
    depends_on:
      - mongo
      - etcd
      - api
      - worker
      - scheduler
    entrypoint: go test ./test/e2e
    environment:
      ETCD_HOST: etcd
      MONGO_HOST: mongo
      SCHEDULER_ADDR: scheduler:9888
    networks:
      - crawlerd-e2e-test

networks:
  crawlerd-e2e-test:
